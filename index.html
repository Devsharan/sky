<!DOCTYPE html>
<html lang="en" ng-app="bygApp">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book Your Ground</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <!--<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>-->

    <!-- Custom styles for this template -->
    <link href="css/main.css" rel="stylesheet">
    <script type="text/javascript" src="js/angular.js"></script>
    <script type="text/javascript" src="js/angular-route.js"></script>
    <script type="text/javascript" src="js/ui-bootstrap-tpls-0.12.1.js"></script>
    <script type="text/javascript" src="js/angular-uuid2.js"></script>
    <script type="text/javascript" src="js/angular-touch.js"></script>
    <script type="text/javascript">

        var bygApp = angular.module("bygApp", ["ngTouch","ngRoute", "ui.bootstrap","angularUUID2"])
                .constant("baseUrl", "http://localhost/sports-grounds")
                .config(function ($routeProvider) {
                    $routeProvider.when("/contact-us", {
                        templateUrl: "views/contact-us.html"
                    });

                    $routeProvider.when("/terms-condition", {
                        templateUrl: "views/terms-condition.html"
                    });
                    $routeProvider.when("/privacy-policy", {
                        templateUrl: "views/privacy-policy.html"
                    });
                    $routeProvider.when("/faq", {
                        templateUrl: "views/faq.html"
                    });
                    $routeProvider.when("/how-it-works", {
                        templateUrl: "views/how-it-works.html"
                    });

                    $routeProvider.when("/ground-details", {
                        templateUrl: "views/ground-details.html"
                    });
                    $routeProvider.when("/view-slots", {
                        templateUrl: "views/view-slots.html"
                    });

                    $routeProvider.when("/checkout-summary", {
                        templateUrl: "views/checkout-summary.html"
                    });
                    $routeProvider.when("/support-details", {
                        templateUrl: "views/support-details.html"
                    });
                    $routeProvider.when("/thank-you", {
                        templateUrl: "views/thank-you.html"
                    });


                    $routeProvider.otherwise({
                        templateUrl: "views/home.html"
                    });
                });

        bygApp.service('initHome', function ($http) {
            this.getCityAndLocation = function () {
                return $http.get("http://localhost/sports-grounds").success(function (data) {
                    console.log(data);
                    return data;
                });
                this.getGroundDetails = function ($date, $sportsName, $location) {
                    return $http.get(
                            {
                                url: "http://localhost/sports-grounds/search",
                                method: "GET",
                                params: {sportsName: $sportsName, date: $date, location: $location}
                            }
                    ).success(function (data) {
                                console.log(data);
                                return data;
                            });
                };
            };
        });


        bygApp.controller("bygMainCntlr", function ($scope, $http, initHome, $filter,uuid2) {

                    $scope.userSessionId = uuid2.newguid();
                    //$scope.getId = function(){ };
                    console.log($scope.userSessionId);
                    initHome.getCityAndLocation().then(function (result) {
                        $scope.sports = result.data;

                    });
                    $scope.searchRequest = {};
                    $scope.groundDetails;
                    $scope.createBookingRequest = { sportsGroundId:"",bookingType:"ONLINE",webIp:"",webSessionId:"", date:"",slot:"" }
                    $scope.slots;
                    $scope.bookingSummary = {baseAmt:0,bookingAmt:0,serviceTax:0,onlineFees:15,totalAmount:""};
                    $scope.userBookingId ="";
                    $scope.updateSlotsToBookingRequest = { bookingId:"",date:"",slot:""};

                    //data access functions starts here

                    $scope.viewGroundDetails = function (initHome) {
                        var date = $filter('date')($scope.searchRequest.date, 'yyyy-MM-dd');
                        var location = $scope.searchRequest.location.City;
                        var sportsName = $scope.searchRequest.sportsName.Sport;
                        console.log(date)
                        console.log(location)
                        console.log(sportsName)
                        $http(
                                {
                                    url: "http://localhost/sports-grounds/search",
                                    method: "GET",
                                    params: {sportsName: sportsName, date: date, location: location}
                                }
                        ).success(function (data) {
                                    console.log(data);
                                    return data;
                                }).then(function (result) {
                                    $scope.groundDetails = result.data;
                                    angular.forEach($scope.groundDetails, function (value) {
                                        value.image = "img/".concat(value.SportsGroundID).concat(".jpeg");
                                    });
                                });

                        console.log($scope.groundDetails)


                    };

                    $scope.viewSlots = function($selectedGround) {

                        $scope.selectedGround = $selectedGround;

                        var date =  $filter('date')('2015-01-04', 'yyyy-MM-dd');//$filter('date')($scope.searchRequest.date, 'yyyy-MM-dd');
                        return $http(
                                {
                                    url: "http://localhost/sports-grounds/" + $selectedGround.SportsGroundID,
                                    method: "GET",
                                    params: {date: date}
                                }
                        ).success(function (data) {
                                    console.log(data);
                                    return data;
                                }).then(function (result) {
                                    // $scope.slots = result.data;

                                    var slotDuration  ;

                                    switch($selectedGround.SlotType) {
                                        case 'Hourly':
                                            slotDuration = 1;
                                            break;
                                        case 'HalfHourly':
                                            slotDuration=1;
                                            break;
                                        default:
                                            slotDuration = 1;
                                    }

                                    var firstSlot = $selectedGround.dailyScheduleFirstSlot;
                                    var lastSlot = $selectedGround.dailyScheduleLastSlot;


                                    function isBooked($slotNumber) {
                                        var isBooked = false;
                                        angular.forEach(result.data, function (bookedSlot) {
                                            if (bookedSlot.Slot === $slotNumber) {
                                                isBooked = true;
                                            }
                                        })
                                        return isBooked;
                                    }

                                    var slots  = [];
                                    var slot = {startTime:"",endTime:"",rate:"",displayText:"",status:"",selected:false};

                                    for(var i=Number(firstSlot);i<=Number(lastSlot);i++) {
                                        if(!isBooked(String(i))){
                                            var intermediateSlot = angular.copy(slot);
                                            intermediateSlot.startTime = String(i).concat(":00");
                                            intermediateSlot.endTime   = String(i+Number(slotDuration)).concat(":00");
                                            intermediateSlot.rate = "800";
                                            intermediateSlot.displayText = "Rs.800";
                                            intermediateSlot.status = "Available";
                                            intermediateSlot.slot = String(i);
                                            intermediateSlot.selected=false;
                                            slots.push(intermediateSlot);
                                        }

                                    }
                                    $scope.slots = slots;
                                    console.log($scope.slots)
                                });
                        ;

                    };

                    $scope.buttonStyle = function (slot) {
                        var slotButtonClass;
                        //  var slot = $scope.currentSelectedSlot ===undefined ? $slot: $scope.currentSelectedSlot;
                        if ((slot.status === "Available") && (slot.selected === true)) {
                            slotButtonClass = "slot ".concat("slot-selected");
                        } else if (slot.status === "Available") {
                            slotButtonClass = "slot ".concat("slot-available");
                        } else if (slot.status !== "Available") {
                            slotButtonClass = "slot ".concat("slot-booked");
                            slot.displayText = slot.status;

                        }

                        return slotButtonClass;
                    }
                    $scope.confirmBooking = function(){
                        console.log("confirm booking");
                        //create user based on user information and confirm booking
                    }
                    $scope.slotSelectionAction = function (slot) {

                        if ((slot.status === "Available")) {

                            if ((slot.selected === false)) {
                                slot.displayText = "Selected";
                                slot.selected = true;
                                //create booking or add slot ot it
                                if($scope.userBookingId==="") {
                                    var bookingRequest = angular.copy($scope.createBookingRequest);
                                    bookingRequest.sportsGroundId = $scope.selectedGround.SportsGroundID;
                                    bookingRequest.bookingType = "ONLINE";
                                    bookingRequest.webIp = "0.0.0.0";
                                    bookingRequest.webSessionId = $scope.userSessionId;
                                    bookingRequest.date = $scope.searchRequest.date;
                                    bookingRequest.slot = slot.slot;
                                    $http(
                                            {
                                                url: "http://localhost/sports-grounds/"+$scope.selectedGround.SportsGroundID+"/slots/"+slot.slot,
                                                method: "POST",
                                                data: bookingRequest,
                                                headers: {
                                                    'Content-Type': 'application/json; charset=utf-8'
                                                }
                                            }
                                    ).success(function (data) {
                                                console.log(data);
                                                return data;
                                            }
                                    ).then(function (result) {
                                                $scope.userBookingId = result.data;
                                                console.log($scope.userBookingId);
                                            }
                                    );

                                }else{
                                    //add slots to it
                                    var addSlotRequest = angular.copy($scope.updateSlotsToBookingRequest);
                                    addSlotRequest.bookingId = $scope.userBookingId;
                                    addSlotRequest.slot = slot.slot;
                                    addSlotRequest.date =  $scope.searchRequest.date;
                                    $http(
                                            {
                                                url: "http://localhost//bookings/"+addSlotRequest.bookingId+"/slots",
                                                method: "PUT",
                                                data: addSlotRequest,
                                                headers: {
                                                    'Content-Type': 'application/json; charset=utf-8'
                                                }
                                            }
                                    ).success(function (data) {
                                                console.log(data);
                                                return data;
                                            }
                                    ).then(function (result) {
                                                console.log("added slots to booking".concat($scope.userBookingId).concat("--->").concat(result.data));
                                            }
                                    );
                                }
                            } else {
                                slot.displayText = "Rs.".concat(slot.rate);
                                slot.selected = false;
                                //remove slot if it is un-selected
                                //add slots to it
                                var removeSlotRequest = angular.copy($scope.updateSlotsToBookingRequest);
                                removeSlotRequest.bookingId = $scope.userBookingId;
                                removeSlotRequest.slot = slot.slot;
                                removeSlotRequest.date =  $scope.searchRequest.date;
                                $http(
                                        {
                                            url: "http://localhost//bookings/"+removeSlotRequest.bookingId+"/slots/"+removeSlotRequest.slot,
                                            method: "DELETE",
                                            data: removeSlotRequest,
                                            headers: {
                                                'Content-Type': 'application/json; charset=utf-8'
                                            }

                                        }
                                ).success(function (data) {
                                            console.log(data);
                                            return data;
                                        }
                                ).then(function (result) {
                                            console.log("removed slots to booking".concat($scope.userBookingId).concat(" and slot ").concat(removeSlotRequest.slot).concat("--->").concat(result.data));
                                        }
                                );
                            }


                            //calculate summary
                            var baseAmount = 0;
                            angular.forEach($scope.slots , function(eachSlot){
                                if(eachSlot.selected===true)
                                    baseAmount = baseAmount+Number(eachSlot.rate);
                            });
                            $scope.bookingSummary.baseAmt = baseAmount;
                            $scope.bookingSummary.bookingAmt = baseAmount/2;
                            $scope.bookingSummary.totalAmount = $scope.bookingSummary.bookingAmt + $scope.bookingSummary.onlineFees+ $scope.bookingSummary.serviceTax;
                        }
                    }

                    $scope.selectionCount = function () {
                        var count = 0;
                        angular.forEach($scope.slots, function (slot) {
                            if (slot.selected == true) {
                                count++;
                            }
                        });
                        return count;
                    }
                    $scope.checkoutSummary = function(){
                        console.log($scope.searchRequest.date)

                    }
                    $scope.resetSession = function(){

                    }

                }
        );

        bygApp.controller('DatepickerDemoCtrl', function ($scope) {
            $scope.today = function () {
                $scope.dt = new Date();
            };
            $scope.today();

            $scope.clear = function () {
                $scope.dt = null;
            };

            // Disable weekend selection
            $scope.disabled = function (date, mode) {
                return ( mode === 'day' && ( date.getDay() === 0 || date.getDay() === 6 ) );
            };

            $scope.toggleMin = function () {
                $scope.minDate = $scope.minDate ? null : new Date();
            };
            $scope.toggleMin();

            $scope.open = function ($event) {
                $event.preventDefault();
                $event.stopPropagation();

                $scope.opened = true;
            };

            $scope.dateOptions = {
                formatYear: 'yy',
                startingDay: 1
            };

            $scope.formats = ['dd-MMMM-yyyy', 'yyyy/MM/dd', 'dd.MM.yyyy', 'shortDate'];
            $scope.format = $scope.formats[0];
        });


    </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script>

    </script>
</head>

<body ng-controller="bygMainCntlr">
<header>
    <ng-include src="'views/header.html'"></ng-include>
</header>
<ng-view></ng-view>
<ng-include src="'views/footer.html'"></ng-include>
<!-- Bootstrap core JavaScript
 ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</body>
</html>